# Kan Specification

A CLI tool for managing kanban boards where all data lives as plain files.

## Overview

Kan is a personal project management tool that stores kanban boards as plain files. There is no database, no server, no external dependencies — just files. Works with any VCS (or none).

### Why This Approach

- **File-based**: Full VCS history, branching, and offline support come free (with any VCS)
- **No vendor lock-in**: Your data is plain files you control
- **Portable and scriptable**: Standard file formats, easy to automate
- **Data lives where work lives**: Boards live alongside the code they track

### Use Case

Personal project management — a kanban board per repo for your various projects, versioned alongside the code.

---

## Data Model

### Directory Structure

```
.kan/
  boards/
    <board-name>/
      config.toml           # board-specific configuration
      cards/
        <flexid>.json       # one file per card
```

The `.kan/` directory is the default location. Users MAY specify a custom location via `kan init --location <relative-path>`, which is persisted in the global user config.

### Global User Config

Location: `~/.config/kan/config.toml`

```toml
# Global defaults
editor = "vim"  # Falls back to $EDITOR, then "vim"

# Known projects (lazily populated by any kan command)
[projects]
my-project = "/Users/name/src/my-project"
another = "/Users/name/src/another"

# Per-repo settings
[repos."/Users/name/src/my-project"]
default_board = "features"
data_location = "tools/kanban"  # if custom location was used
```

The projects registry enables future `-p` flag functionality for managing boards from anywhere.

### Board Config

Location: `.kan/boards/<board-name>/config.toml`

```toml
# Board identity
id = "k7xQ2m"  # flexid, immutable after creation
name = "features"

# Columns (ordered)
[[columns]]
name = "backlog"
color = "#6b7280"

[[columns]]
name = "next"
color = "#3b82f6"

[[columns]]
name = "in-progress"
color = "#f59e0b"

[[columns]]
name = "done"
color = "#10b981"

# Default column for 'kan add'
default_column = "backlog"

# Labels
[[labels]]
name = "bug"
color = "#ef4444"
description = "Something is broken"

[[labels]]
name = "enhancement"
color = "#8b5cf6"

# Custom field schemas
[custom_fields.priority]
type = "enum"
values = ["low", "medium", "high"]

[custom_fields.assignee]
type = "string"

[custom_fields.due_date]
type = "date"
```

Default columns when creating a new board: `backlog`, `next`, `in-progress`, `done`.

### Card Schema

Location: `.kan/boards/<board-name>/cards/<flexid>.json`

```json
{
  "id": "k7xQ2m",
  "alias": "fix-login-bug",
  "alias_explicit": false,
  "title": "Fix login bug",
  "description": "Users are getting logged out randomly after 5 minutes.",
  "column": "in-progress",
  "labels": ["bug"],
  "parent": "m3Yp8n",
  "creator": "amterp",
  "created_at_millis": 1704307200000,
  "updated_at_millis": 1704393600000,
  "comments": [
    {
      "id": "c_9kL2x",
      "body": "Might be related to the session token changes from last week.",
      "author": "amterp",
      "created_at_millis": 1704310800000
    }
  ],
  "priority": "high"
}
```

#### Field Definitions

| Field | Required | Description |
|-------|----------|-------------|
| `id` | Yes | Unique identifier generated via [flexid](https://github.com/amterp/flexid) |
| `alias` | Yes | Human-friendly slug, auto-generated from title by default |
| `alias_explicit` | Yes | Boolean. If `false`, alias updates when title changes. If `true`, alias is frozen until explicitly changed or cleared. |
| `title` | Yes | Card title |
| `description` | No | Detailed description (may contain markdown) |
| `column` | Yes | Current column (must reference a column defined in board config) |
| `labels` | No | Array of label names (must reference labels defined in board config) |
| `parent` | No | ID of parent card (for subtask relationships). MAY reference cards in other boards within the same repo. |
| `creator` | Yes | Username of card creator |
| `created_at_millis` | Yes | Creation timestamp in milliseconds since Unix epoch |
| `updated_at_millis` | Yes | Last update timestamp in milliseconds since Unix epoch |
| `comments` | No | Array of comment objects |
| (custom fields) | No | Any fields defined in board's `custom_fields` config |

#### Alias Behavior

- Auto-generated by slugifying the title (lowercase, spaces to hyphens, etc.)
- On collision, auto-suffix with incrementing number: `fix-bug`, `fix-bug-2`, `fix-bug-3`
- Frontends SHOULD allow users to explicitly set an alias, which sets `alias_explicit: true`
- Frontends SHOULD allow users to clear an explicit alias, reverting to auto-generation
- Card references in data (e.g., `parent` field) MUST use the card ID, not alias

#### Comment Schema

| Field | Required | Description |
|-------|----------|-------------|
| `id` | Yes | Unique identifier (flexid, prefixed with `c_`) |
| `body` | Yes | Comment text |
| `author` | Yes | Username of comment author |
| `created_at_millis` | Yes | Creation timestamp in milliseconds since Unix epoch |

---

## CLI Commands

Written in Go using [ra](https://github.com/amterp/ra) for command-line parsing.

### First Take (MVP)

#### `kan init`

Initialize Kan in the current directory.

```bash
kan init [--location <relative-path>]
```

- Creates `.kan/` directory (or custom location if specified)
- Creates a default board named `main` with default columns
- Registers the project in global user config

If `--location` is specified and the path already exists with valid Kan data, registers the existing project without re-initializing.

#### `kan board`

Manage boards.

```bash
kan board create <name>    # Create a new board with default columns
kan board list             # List all boards in the repo
```

#### `kan add`

Add a new card.

```bash
kan add <title> [description] [flags]
```

**Positional arguments:**
- `title` (required): Card title
- `description` (optional): Card description

**Flags:**
- `-b, --board <name>`: Target board
- `-c, --column <name>`: Target column (defaults to board's `default_column`)
- `-l, --label <name>`: Add label (repeatable)
- `-p, --parent <id|alias>`: Set parent card
- `-I, --non-interactive`: Fail instead of prompting for missing required fields

**Behavior:**
- Interactive by default: if any required fields are missing, prompts the user
- With `-I`: fails with an error if required fields are missing
- Board selection:
  - If only one board exists, uses that board
  - If multiple boards exist and `-b` not specified, uses configured `default_board`
  - If multiple boards exist, no `-b`, and no default configured, prompts (or fails with `-I`)
- Column defaults to the board's configured `default_column` (first column if not configured)
- Creator is automatically set (from `$KAN_USER`, `git config user.name`, or `$USER`)

#### `kan edit`

Edit an existing card.

```bash
kan edit <id|alias>
```

Opens an interactive menu to select which field to edit, then opens `$EDITOR` for that field.

Editor resolution order:
1. `editor` from global user config
2. `$EDITOR` environment variable
3. `vim`

#### `kan show`

Display card details.

```bash
kan show <id|alias>
```

Displays all card fields in a readable format.

#### `kan list`

List cards.

```bash
kan list [flags]
```

**Flags:**
- `-b, --board <name>`: Filter by board
- `-c, --column <name>`: Filter by column

---

### Future Roadmap

The following are planned but NOT part of the first take:

#### CLI Extensions

- `kan move <id|alias> <column>`: Move card to a different column
- `kan archive <id|alias>`: Delete card from working tree (recoverable via VCS history)
- `kan comment <id|alias> [text]`: Add comment (opens `$EDITOR` if text not provided)
- `kan config`: Manage board configuration (columns, labels, custom fields)
- `-p, --project <fuzzy-name>`: Global flag to operate on a different registered project from anywhere

#### Relationships

- "Related to" links between cards (bidirectional)
- "Blocked by" dependencies (directional)

#### Archival

- `kan archive search <query>`: Search archived cards via VCS history

#### Frontends

**Phase 1**: Kan's file-based architecture means anyone can build frontends that read/write the `.kan/` directory. The file format is the interface.

**Phase 2**: A web frontend will be embedded in the Go CLI binary and served via a `kan` command (e.g., `kan web` or `kan serve`). This provides a localhost browser interface out of the box.

**Future**: The same pattern could support additional embedded frontends (TUI, etc.) launched via CLI commands.

---

## Design Decisions

### One File Per Card

**Decision**: Each card is stored as a separate JSON file.

**Rationale**: VCS tools handle merges at the file level. With one file per card:
- Adding cards rarely conflicts (different files)
- Conflicts only occur when two people edit the *same* card — a real conflict worth surfacing
- The alternative (JSONL with one card per line) causes spurious conflicts on concurrent additions

**Trade-off**: Directory with many files (hundreds to low thousands). Acceptable for tooling; `ls` becomes unwieldy but that's not the primary interface.

### JSON for Data, TOML for Config

**Decision**: Card files are JSON. Configuration files are TOML.

**Rationale**:
- JSON is structured and tooling-friendly for data that's primarily machine-read/written
- TOML is more human-readable for configuration that users may hand-edit
- Both are still editable in a pinch if needed

### Flexid for Card IDs

**Decision**: Use [flexid](https://github.com/amterp/flexid) for generating card IDs.

**Rationale**: Short, low-collision identifiers that are reasonable to type in CLI commands. Not fully human-memorable, hence the alias system.

### Alias as Derived Field

**Decision**: Aliases are auto-generated from titles but can be explicitly overridden.

**Rationale**: Provides human-friendly card references (`fix-login-bug`) without coupling filesystem structure to mutable data. The ID remains stable; the alias is a convenience layer.

### Comments Embedded in Card

**Decision**: Comments are stored as an array within the card JSON, not as separate files.

**Rationale**: Simpler model. A card is the atomic unit of work. Comment volume per card is expected to be low (personal project management, not team collaboration).

### Board as Directory

**Decision**: Each board is a subdirectory with its own config and cards. Boards have a flexid (stored in config) and a name (used as directory name).

**Rationale**: Clean isolation. Board-specific configuration lives with the board. Deleting a board is deleting a directory. Cross-board references are still possible via card IDs. The flexid provides a stable internal identifier if needed for future features.

### Global Project Registry

**Decision**: Kan maintains a registry of known projects in `~/.config/kan/config.toml`, lazily populated by any `kan` command run in a Kan-enabled project.

**Rationale**: Enables future `-p` flag for operating on projects from anywhere. No explicit registration step needed.

### No Plugin Architecture

**Decision**: Frontends are not plugins. They're independent tools that read/write Kan's file format.

**Rationale**: The file format *is* the API. Anyone can build a TUI, web UI, or integration by reading `.kan/` files. No need for Kan to define a plugin interface.

---

## Open Questions

None currently blocking. The following are explicitly deferred:

- **GitHub/GitLab issues sync**: Likely a frontend/integration concern, not core Kan
- **Multi-repo boards**: Explicitly out of scope. Boards are per-repo.
